export const DEFAULT_LOCALE = "pt-BR";
export const I18N_STORAGE_KEY = "iot-sentinel.locale";

export const locales = [DEFAULT_LOCALE, "en"] as const;

export type Locale = (typeof locales)[number];

function isLocale(value: string): value is Locale {
  return locales.includes(value as Locale);
}

const ptBR = {
  "layout.nav.dashboard": "Dashboard",
  "layout.nav.devices": "Dispositivos",
  "layout.nav.deviceTypes": "Tipos de Dispositivo",
  "layout.nav.locations": "Localizacoes",
  "layout.nav.discoveredHosts": "Hosts Descobertos",
  "layout.nav.settings": "Configuracoes",
  "layout.searchPlaceholder": "Buscar dispositivos, hosts, localizacoes...",
  "layout.logout": "Sair",
  "layout.language": "Idioma",
  "layout.languagePtBr": "Portugues (BR)",
  "layout.languageEn": "Ingles",
  "login.subtitle": "Plataforma de gerenciamento e monitoramento IoT",
  "login.email": "Email",
  "login.password": "Senha",
  "login.submit": "Entrar",
  "login.error": "Falha no login",
  "dashboard.subtitle": "Visao geral do ambiente IoT Sentinel",
  "dashboard.empty.title": "Voce ainda nao cadastrou Tipos de Dispositivo e Localizacoes.",
  "dashboard.empty.createDeviceType": "Criar Tipo de Dispositivo",
  "dashboard.empty.createLocation": "Criar Localizacao",
  "dashboard.stats.deviceTypes": "Tipos de Dispositivo",
  "dashboard.stats.locations": "Localizacoes",
  "devices.subtitle": "Inventario de dispositivos registrados",
  "devices.table.name": "Nome",
  "devices.table.status": "Status",
  "devices.table.lastSeen": "Ultima vez visto",
  "devices.table.action": "Acao",
  "devices.table.details": "Detalhes",
  "deviceDetail.defaultTitle": "Detalhes do Dispositivo",
  "deviceDetail.subtitle": "Informacoes detalhadas e interfaces de rede",
  "deviceDetail.back": "Voltar",
  "deviceDetail.status": "Status",
  "deviceDetail.unknown": "desconhecido",
  "deviceDetail.noNotes": "Sem notas",
  "deviceDetail.table.type": "Tipo",
  "deviceTypes.subtitle": "Cadastre os tipos de dispositivos suportados",
  "deviceTypes.new": "Novo Tipo de Dispositivo",
  "deviceTypes.edit": "Editar Tipo de Dispositivo",
  "deviceTypes.nameRequired": "Nome e obrigatorio.",
  "deviceTypes.categoryRequired": "Categoria e obrigatoria.",
  "deviceTypes.protocolsInvalid": "Protocolos padrao devem ser um JSON array valido.",
  "deviceTypes.fieldName": "Nome",
  "deviceTypes.fieldCategory": "Categoria",
  "deviceTypes.fieldDefaultProtocols": "Protocolos Padrao (JSON array)",
  "common.table.name": "Nome",
  "common.table.category": "Categoria",
  "common.table.updatedAt": "Atualizado em",
  "common.table.actions": "Acoes",
  "common.edit": "Editar",
  "common.delete": "Excluir",
  "common.saveChanges": "Salvar Alteracoes",
  "common.create": "Criar",
  "common.cancel": "Cancelar",
  "common.details": "Detalhes",
  "locations.subtitle": "Mapeie cada localizacao fisica",
  "locations.new": "Nova Localizacao",
  "locations.callout.title": "Crie um Building primeiro",
  "locations.callout.body": "Sem buildings cadastrados, nao e possivel criar localizacoes.",
  "locations.gotoSettings": "Ir para Configuracoes",
  "locations.pathRequired": "Path e obrigatorio.",
  "locations.buildingRequired": "Selecione um building.",
  "locations.edit": "Editar Localizacao",
  "locations.selectBuilding": "Selecione um building",
  "locations.table.path": "Path",
  "locations.table.building": "Building",
  "locations.table.details": "Detalhes",
  "locations.modal.new": "Nova Localizacao",
  "locations.modal.edit": "Editar Localizacao",
  "locations.field.building": "Building",
  "locations.field.path": "Path",
  "locations.field.details": "Detalhes",
  "settings.subtitle": "Gerenciamento de Buildings",
  "settings.buildingName": "Nome do Building",
  "settings.notes": "Observacoes",
  "settings.notesOptional": "Opcional",
  "settings.examplePlaceholder": "Ex: Matriz - Bloco A",
  "settings.createBuilding": "Criar Building",
  "settings.nameRequired": "Nome do building e obrigatorio.",
  "settings.table.updated": "Atualizado",
  "discoveredHosts.subtitle": "Hosts encontrados por scans",
  "discoveredHosts.dependencies.title": "Dependencias pendentes",
  "discoveredHosts.dependencies.body": "Para registrar hosts, crie ao menos 1 Tipo de Dispositivo e 1 Localizacao.",
  "discoveredHosts.createDeviceType": "Criar Tipo de Dispositivo",
  "discoveredHosts.createLocation": "Criar Localizacao",
  "discoveredHosts.table.hostname": "Hostname",
  "discoveredHosts.table.vendor": "Fabricante",
  "discoveredHosts.pending": "Pendente",
  "discoveredHosts.registered": "Registrado",
  "discoveredHosts.register": "Registrar",
  "api.unauthorized": "Nao autorizado",
  "api.sessionExpired": "Sessao expirada",
  "api.requestFailed": "Falha na requisicao",
  "api.invalidCredentials": "Credenciais invalidas",
  "api.invalidRefreshToken": "Refresh token invalido",
  "api.refreshTokenExpired": "Refresh token expirado",
  "api.invalidTokenType": "Tipo de token invalido",
  "api.invalidToken": "Token invalido",
  "api.unauthorizedInternal": "Acesso interno nao autorizado",
  "api.validationFailed": "Falha de validacao",
  "api.emailAlreadyExists": "Email ja existe",
  "api.userNotFound": "Usuario nao encontrado",
  "api.invalidForeignKeys": "Relacionamentos invalidos",
  "api.notFound": "Nao encontrado",
  "api.deviceNotFound": "Dispositivo nao encontrado",
  "api.hostNotFound": "Host nao encontrado",
  "api.hostAlreadyRegistered": "Host ja registrado",
  "api.invalidBuildingId": "Building invalido"
} as const;

const en: Record<keyof typeof ptBR, string> = {
  "layout.nav.dashboard": "Dashboard",
  "layout.nav.devices": "Devices",
  "layout.nav.deviceTypes": "Device Types",
  "layout.nav.locations": "Locations",
  "layout.nav.discoveredHosts": "Discovered Hosts",
  "layout.nav.settings": "Settings",
  "layout.searchPlaceholder": "Search devices, hosts, locations...",
  "layout.logout": "Logout",
  "layout.language": "Language",
  "layout.languagePtBr": "Portuguese (BR)",
  "layout.languageEn": "English",
  "login.subtitle": "IoT management and monitoring platform",
  "login.email": "Email",
  "login.password": "Password",
  "login.submit": "Sign in",
  "login.error": "Login failed",
  "dashboard.subtitle": "Overview of the IoT Sentinel environment",
  "dashboard.empty.title": "You have not created Device Types and Locations yet.",
  "dashboard.empty.createDeviceType": "Create Device Type",
  "dashboard.empty.createLocation": "Create Location",
  "dashboard.stats.deviceTypes": "Device Types",
  "dashboard.stats.locations": "Locations",
  "devices.subtitle": "Inventory of registered devices",
  "devices.table.name": "Name",
  "devices.table.status": "Status",
  "devices.table.lastSeen": "Last Seen",
  "devices.table.action": "Action",
  "devices.table.details": "Details",
  "deviceDetail.defaultTitle": "Device Detail",
  "deviceDetail.subtitle": "Detailed information and network interfaces",
  "deviceDetail.back": "Back",
  "deviceDetail.status": "Status",
  "deviceDetail.unknown": "unknown",
  "deviceDetail.noNotes": "No notes",
  "deviceDetail.table.type": "Type",
  "deviceTypes.subtitle": "Register supported device types",
  "deviceTypes.new": "New Device Type",
  "deviceTypes.edit": "Edit Device Type",
  "deviceTypes.nameRequired": "Name is required.",
  "deviceTypes.categoryRequired": "Category is required.",
  "deviceTypes.protocolsInvalid": "Default protocols must be a valid JSON array.",
  "deviceTypes.fieldName": "Name",
  "deviceTypes.fieldCategory": "Category",
  "deviceTypes.fieldDefaultProtocols": "Default Protocols (JSON array)",
  "common.table.name": "Name",
  "common.table.category": "Category",
  "common.table.updatedAt": "Updated At",
  "common.table.actions": "Actions",
  "common.edit": "Edit",
  "common.delete": "Delete",
  "common.saveChanges": "Save Changes",
  "common.create": "Create",
  "common.cancel": "Cancel",
  "common.details": "Details",
  "locations.subtitle": "Map each physical location",
  "locations.new": "New Location",
  "locations.callout.title": "Create a Building first",
  "locations.callout.body": "Without buildings, it is not possible to create locations.",
  "locations.gotoSettings": "Go to Settings",
  "locations.pathRequired": "Path is required.",
  "locations.buildingRequired": "Select a building.",
  "locations.edit": "Edit Location",
  "locations.selectBuilding": "Select building",
  "locations.table.path": "Path",
  "locations.table.building": "Building",
  "locations.table.details": "Details",
  "locations.modal.new": "New Location",
  "locations.modal.edit": "Edit Location",
  "locations.field.building": "Building",
  "locations.field.path": "Path",
  "locations.field.details": "Details",
  "settings.subtitle": "Building management",
  "settings.buildingName": "Building Name",
  "settings.notes": "Notes",
  "settings.notesOptional": "Optional",
  "settings.examplePlaceholder": "Ex: HQ - Block A",
  "settings.createBuilding": "Create Building",
  "settings.nameRequired": "Building name is required.",
  "settings.table.updated": "Updated",
  "discoveredHosts.subtitle": "Hosts found by scans",
  "discoveredHosts.dependencies.title": "Pending dependencies",
  "discoveredHosts.dependencies.body": "To register hosts, create at least 1 Device Type and 1 Location.",
  "discoveredHosts.createDeviceType": "Create Device Type",
  "discoveredHosts.createLocation": "Create Location",
  "discoveredHosts.table.hostname": "Hostname",
  "discoveredHosts.table.vendor": "Vendor",
  "discoveredHosts.pending": "Pending",
  "discoveredHosts.registered": "Registered",
  "discoveredHosts.register": "Register",
  "api.unauthorized": "Unauthorized",
  "api.sessionExpired": "Session expired",
  "api.requestFailed": "Request failed",
  "api.invalidCredentials": "Invalid credentials",
  "api.invalidRefreshToken": "Invalid refresh token",
  "api.refreshTokenExpired": "Refresh token expired",
  "api.invalidTokenType": "Invalid token type",
  "api.invalidToken": "Invalid token",
  "api.unauthorizedInternal": "Unauthorized internal access",
  "api.validationFailed": "Validation failed",
  "api.emailAlreadyExists": "Email already exists",
  "api.userNotFound": "User not found",
  "api.invalidForeignKeys": "Invalid foreign keys",
  "api.notFound": "Not found",
  "api.deviceNotFound": "Device not found",
  "api.hostNotFound": "Host not found",
  "api.hostAlreadyRegistered": "Host already registered",
  "api.invalidBuildingId": "Invalid building_id"
};

const dictionaries: Record<Locale, Record<keyof typeof ptBR, string>> = {
  "pt-BR": ptBR,
  en
};

const backendMessageKeyMap: Partial<Record<string, keyof typeof ptBR>> = {
  Unauthorized: "api.unauthorized",
  "Session expired": "api.sessionExpired",
  "Request failed": "api.requestFailed",
  "Invalid credentials": "api.invalidCredentials",
  "Invalid refresh token": "api.invalidRefreshToken",
  "Refresh token expired": "api.refreshTokenExpired",
  "Invalid token type": "api.invalidTokenType",
  "Invalid token": "api.invalidToken",
  "Unauthorized internal access": "api.unauthorizedInternal",
  "Validation failed": "api.validationFailed",
  "Email already exists": "api.emailAlreadyExists",
  "User not found": "api.userNotFound",
  "Invalid foreign keys": "api.invalidForeignKeys",
  "Not found": "api.notFound",
  "Device not found": "api.deviceNotFound",
  "Host not found": "api.hostNotFound",
  "Host already registered": "api.hostAlreadyRegistered",
  "Invalid building_id": "api.invalidBuildingId"
};

export type TranslationKey = keyof typeof ptBR;

export function getStoredLocale(): Locale {
  if (typeof window === "undefined") return DEFAULT_LOCALE;
  const value = window.localStorage.getItem(I18N_STORAGE_KEY);
  if (value && isLocale(value)) return value;
  return DEFAULT_LOCALE;
}

export function storeLocale(locale: Locale) {
  if (typeof window === "undefined") return;
  window.localStorage.setItem(I18N_STORAGE_KEY, locale);
}

export function tForLocale(locale: Locale, key: TranslationKey): string {
  return dictionaries[locale][key];
}

export function translateBackendMessage(message: string, locale: Locale): string {
  const key = backendMessageKeyMap[message.trim()];
  if (!key) return message;
  return tForLocale(locale, key);
}
